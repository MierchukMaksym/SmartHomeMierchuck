{% extends "smarthome/base.html" %}
{% block title %}{{ room.name }}{% endblock %}

{% block content %}
<style>
.device-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 12px;
    margin-bottom: 30px;
}
.device-card {
    border-radius: 12px;
    border: 1px solid #ddd;
    background-color: #fafafa;
    padding: 10px;
    height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    cursor: pointer;
    transition: 0.3s;
}
.device-card:hover {
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    background-color: #f3f4f6;
}
input[type="range"].vertical-slider {
    -webkit-appearance: slider-vertical;
    writing-mode: bt-lr;
    width: 100%;
    height: 150px;
    padding: 0;
    margin: 10px auto;
}
input[type="range"].fat-slider {
    appearance: none;
    width: 100%;
    height: 14px;
    background: #d1d5db;
    border-radius: 8px;
    outline: none;
}
input[type="range"].fat-slider::-webkit-slider-thumb {
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #4f46e5;
    cursor: pointer;
    box-shadow: 0 0 5px #6366f1;
}
input[type="range"].fat-slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #4f46e5;
    cursor: pointer;
    box-shadow: 0 0 5px #6366f1;
}
.power-button {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background-color: #eee;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: 0.2s;
    cursor: pointer;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
}
.power-button.on {
    background-color: #4ade80;
    color: white;
    box-shadow: 0 0 8px 3px #4ade80;
}
.power-button.off {
    background-color: #e5e7eb;
    color: #888;
    box-shadow: none;
}
</style>

<h4 class="text-center mb-4">{{ room.icon }} {{ room.name }}</h4>

{% if devices %}
    <div class="device-grid">
      {% for device in devices %}
        <div class="device-card" onclick="loadDeviceSettings({{ device.id }})">
            <div style="font-size: 22px;">{{ device.icon }}</div>
            <div style="font-size: 14px;">{{ device.name }}</div>
        </div>
      {% endfor %}
    </div>
{% else %}
    <p class="text-muted text-center mb-4">–£ —Ü—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ —â–µ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é üò¥</p>
{% endif %}

    {% if switches %}
<h5 class="mt-4 mb-2">üîò –í–∏–º–∏–∫–∞—á—ñ:</h5>
<div class="d-grid gap-3">
  {% for switch in switches %}
    <div class="p-3 border rounded-3 shadow-sm">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <strong style="font-size: 18px;">{{ switch.icon }} {{ switch.name }}</strong><br>
          <small class="text-muted">
            –ö–µ—Ä—É—î:
            {% for lamp in switch.linked_lamps.all %}
              {{ lamp.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              (–Ω–µ–º–∞—î –ª–∞–º–ø)
            {% endfor %}
          </small>
        </div>
        <button class="btn btn-outline-primary fw-bold"
                onclick="toggleSwitch('{{ switch.id }}')">
          ‚èª –ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏
        </button>
      </div>
    </div>
  {% endfor %}
</div>
{% endif %}


<!-- ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
<div id="device-settings-area">
    <p class="text-center text-muted">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–∏—Å—Ç—Ä—ñ–π –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚¨ÜÔ∏è</p>
</div>

<!-- ‚ûï –î–æ–¥–∞—Ç–∏ –ø—Ä–∏—Å—Ç—Ä—ñ–π -->
<button class="add-btn" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
    ‚ûï –î–æ–¥–∞—Ç–∏ –ø—Ä–∏—Å—Ç—Ä—ñ–π
</button>
    <!-- ‚ûï –î–æ–¥–∞—Ç–∏ –≤–∏–º–∏–∫–∞—á -->
<button class="add-btn" data-bs-toggle="modal" data-bs-target="#addSwitchModal">
    ‚ûï –î–æ–¥–∞—Ç–∏ –≤–∏–º–∏–∫–∞—á
</button>


<a href="{% url 'home' %}" class="d-block mt-4 text-center text-decoration-none text-muted">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>

<!-- –ú–û–î–ê–õ–ö–ê -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="addDeviceModalLabel">–î–æ–¥–∞—Ç–∏ –ø—Ä–∏—Å—Ç—Ä—ñ–π</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{% url 'add_device_to_room' room.id %}">
            {% csrf_token %}
            <div class="d-grid gap-3">
                {% for item in add_forms %}
                    <button type="submit" name="device_type" value="{{ item.type }}" class="btn btn-outline-primary d-flex align-items-center justify-content-between p-3 rounded-3">
                        <span>{{ item.label }}</span>
                        <span style="font-size: 20px;">{{ item.icon }}</span>
                    </button>
                {% endfor %}
            </div>
        </form>
      </div>
    </div>
  </div>
</div>


    <!-- –ú–û–î–ê–õ–ö–ê: –¥–æ–¥–∞—Ç–∏ –≤–∏–º–∏–∫–∞—á -->
<div class="modal fade" id="addSwitchModal" tabindex="-1" aria-labelledby="addSwitchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="addSwitchModalLabel">üîò –ù–æ–≤–∏–π –≤–∏–º–∏–∫–∞—á</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{% url 'add_switch_to_room' room.id %}">
          {% csrf_token %}

          <div class="d-grid gap-3">
            <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞ –≤–∏–º–∏–∫–∞—á–∞" class="form-control form-control-lg rounded-3">

            <input type="text" name="icon" placeholder="–Ü–∫–æ–Ω–∫–∞ (–Ω–∞–ø—Ä. üîò)" class="form-control form-control-lg rounded-3">

            <div class="border rounded-3 p-3" style="max-height: 200px; overflow-y: auto;">
              <label class="form-label mb-2">–Ø–∫–∏–º–∏ –ª–∞–º–ø–∞–º–∏ –∫–µ—Ä—É—î?</label>
              {% for lamp in switch_form.fields.linked_lamps.queryset %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="linked_lamps" value="{{ lamp.id }}" id="lamp{{ lamp.id }}">
                  <label class="form-check-label" for="lamp{{ lamp.id }}">
                    {{ lamp.icon }} {{ lamp.name }} <small class="text-muted">({{ lamp.room.name }})</small>
                  </label>
                </div>
              {% endfor %}
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-2 fw-bold">üíæ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≤–∏–º–∏–∫–∞—á</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>




<!-- üîß –°–ö–†–ò–ü–¢–´ -->
<script>
function loadDeviceSettings(deviceId) {
    fetch(`/device/settings/${deviceId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById("device-settings-area").innerHTML = data.html;
        });
}

function toggleDevice(deviceId) {
    const btn = document.querySelector(`button[data-device-id="${deviceId}"]`);
    if (!btn) {
        console.warn("Button not found for device:", deviceId);
        return;
    }

    const isCurrentlyOn = btn.classList.contains('on');
    const newValue = !isCurrentlyOn;

    console.log("‚èª TOGGLE device", deviceId, "‚Üí", newValue);

    fetch('/device/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            device_id: deviceId,
            field: 'is_on',
            value: newValue
        })
    }).then(() => {
        btn.classList.remove('on', 'off');
        btn.classList.add(newValue ? 'on' : 'off');
    });
}

function updateDevice(deviceId, field, value) {
    console.log("üõ† updateDevice", deviceId, field, value);
    fetch('/device/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            device_id: deviceId,
            field: field,
            value: value
        })
    });
}

function toggleSwitch(switchId) {
    fetch(`/switch/toggle/${switchId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log(`üîò Switch toggled. Result: ${data.message}`);
        // –ø–æ –∂–µ–ª–∞–Ω–∏—é –º–æ–∂–Ω–æ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä reload —Ç–µ–∫—É—â–µ–π –ª–∞–º–ø—ã
        loadDeviceSettings(data.last_lamp_id);  // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å
    });
}

</script>
{% endblock %}
